<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Resultados - DuckSurveys</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 th:text="'Resultados: ' + ${survey.title}">An√°lisis</h1>
        <a href="/admin/dashboard" class="btn btn-secondary">Volver</a>
    </div>

    <div th:each="q : ${survey.questions}" class="card mb-4 shadow-sm">
        <div class="card-header bg-dark text-white fw-bold" th:text="${q.questionText}">Pregunta</div>
        <div class="card-body">

            <div th:if="${q.questionType.name() != 'OPEN'}" style="max-height: 250px;">
                <canvas th:id="'chart-' + ${q.id}"></canvas>
                <script th:inline="javascript">
                    (function() {
                        const ctx = document.getElementById('chart-' + [[${q.id}]]);

                        // Recogemos etiquetas
                        const labels = [[${q.options.![optionText]}]];

                        // Recogemos votos llamando al repositorio por cada ID
                        const dataVotos = [];
                        /*[# th:each="opt : ${q.options}"]*/
                            dataVotos.push([[${respo.countBySelectedOptionId(opt.id)}]]);
                        /*[/]*/

                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Votos',
                                    data: dataVotos,
                                    backgroundColor: 'rgba(255, 193, 7, 0.6)',
                                    borderColor: 'rgba(255, 193, 7, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
                            }
                        });
                    })();
                </script>
            </div>

            <div th:if="${q.questionType.name() == 'OPEN'}">
                <ul class="list-group list-group-flush">
                    <li th:each="r : ${respo.findByQuestionIdAndResponseTextIsNotNull(q.id)}"
                        class="list-group-item" th:text="${r.responseText}">Respuesta</li>
                    <li th:if="${respo.findByQuestionIdAndResponseTextIsNotNull(q.id).empty}"
                        class="list-group-item text-muted text-center">Sin respuestas.</li>
                </ul>
            </div>

        </div>
    </div>
</div>
</body>
</html>